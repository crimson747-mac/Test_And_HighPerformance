CPU 프로파일링
=============

## CPU 프로파일링?
리소스 사용량을 측정할 때 소프트웨어를 사용해분석한다. 세부적으로 CPU프로파일링을 통해 함수가 얼마나 그리고 어떻게 프로세서를 사용하는지 확인할 수 있다. 또한 반대 상황으로 유휴시간이라고 하는 프로세서를 사용하지 않는 시간도 분석할 수 있다.


### Node의 특징
- Node는 기본적으로 CPU집약적인 작업으로 간주되지 않기 때문에 프로파일링을 수행할 때 프로세서를 점유하고 다른 작업들의 성능을 저해하는 집약적인 작업을 가진 메서드를 확인 하는 것이 중요하다

- Node는 이벤트루프를 통해 실행되기 때문에 이벤트 루프가 재시작해야 다음에 수행할 이벤트를 처리할 수 있다. 따라서 코드가 종료되지 않는 다면, 앱은 해당 코드가 종료되기 전까지 대기상태로 유지된다. 따라서 앱의 성능 유지를 위해 큰 작업을 가능한 작게 나눠야 한다.


#### 1. 로그파일 생성 및 작업실행
- 서버를 시작하고 로그파일을 생성한다. (경로에 *.log 파일이 생긴다)
```
node --prof app.js
```

#### 2. 서버로 스트레스 요청을보내 작업을 log에 기록하게 한다.
- 테스트를 수행하면 해당 CPU 작업을 자동으로 log 파일에 기록
```
ab -n 10 -c 2 http://localhost:3000/
```

#### 3. 로그파일 분석
- 로그파일을 확인할 수 있는 상태로 변환한다.
- 여기서는 피보나치 수열을 재귀의 형태로 구현하였는데 재귀 함수는 profile 에서 자동으로 들여쓰기로 나타난다. (재귀는 cpu의 성능하락에 매우 직결되기 때문에 이를 항상 인지하자)
```
node --prof--process {logfile}
```

#### 4. 유의사항
- 테스트 수행시에는 정확히 벤치마크 수행시간만큼만 서버를 동작시켜 발생할 수 있는 다른 변수를 미리 방지하자


플레임 그래프
=============


## 플레임 그래프란?
- 플레인 그래프는 비교적 빠르고 정확하게 가장 자주 사용되는 함수를 찾는데 유용한 시각화기법이다. 이 그래프는 여러 개의 적측된 형태를 지는 블록으로 구성돼있고 각 블록은 함수 호출을 의미한다.

- 이 그래프는 메모리의 사용과 누수를 탐지하기 위한 목적으로 사용할 수 있다. 예를 들어 CPU가 어떻게 사용되는지 보기위해 사용한다.

#### 1. Requirement
```
npm install -g flamebearer
```

#### 2. 로그파일 생성 및 작업실행
- 서버를 시작하고 로그파일을 생성한다. (경로에 *.log 파일이 생긴다)
```
node --prof app.js
```

#### 3. 서버로 스트레스 요청을보내 작업을 log에 기록하게 한다.
- 테스트를 수행하면 해당 CPU 작업을 자동으로 log 파일에 기록
```
ab -n 10 -c 2 http://localhost:3000/
```

#### 4. Flamegraph를 생성(html)하고 열기
- 유의사항: 서버가 실행중이어야 한다.
```
node --prof-process --preprocess -j isolate*.log | flamebearer
```

#### 5. 보는 방법
- 일반적으로 크고 넓은 형태의 플레임그래프는 CPU가 지나치게 사용되고 있음을 의미한다.
- 반면, 높고 얇은 형태의 플레임그래프는 사용률이 낮음을 의미한다.
- 일반적으로는 높고 얇은 형태의 플레임 그래프를 지향해야 한다.

###### 개인적인 생각
- 메모리 힙 스냅샷보다 직관적이다.
- 같은 역할을 수행하는 수많은 라이브러리가 차고 넘치는 상황에서 각각의 라이브러리 성능을 비교하여 어떤 것을 사용할지 결정할 수 있는 지표를 생성할 수 있다.
- 클라우드 서비스로 서버를 제공하여 CPU나 메모리 크기에 따라 비용을 지불하는 환경에서 최적을 선택할 수 있도록 보조해준다.
- 도커의 등장으로 동일한(독립적) 환경에서 테스트가 가능하므로 시너지를 기대할 수 있다.